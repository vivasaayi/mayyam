name: CI
env:
  ENABLE_INTEGRATION: ${{ secrets.ENABLE_INTEGRATION }}

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

jobs:
  backend-tests:
    name: Backend tests (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            backend/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Run backend unit tests
        env:
          DATABASE_URL: "sqlite::memory:"
          RUST_LOG: "info"
          AWS_ACCESS_KEY_ID: ""
          AWS_SECRET_ACCESS_KEY: ""
        run: |
          cd backend
          cargo test --workspace --all-targets

  frontend-tests:
    name: Frontend tests (Node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Run unit tests
        run: cd frontend && CI=true npm test --silent -- --watchAll=false

  local-tests:
    name: Local tests runner
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Ensure script is executable
        run: chmod +x ./run-local-tests.sh
      - name: Run full local test script
        run: |
          chmod +x ./run-local-tests.sh
          ./run-local-tests.sh

  integration-tests:
    name: Integration tests (Docker Compose)
    runs-on: ubuntu-latest
    needs: local-tests
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && env.ENABLE_INTEGRATION == 'true') }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Compose
        run: docker compose version
      - name: Install Amazon/utility tools
        run: sudo apt-get update && sudo apt-get -y install jq
      - name: Decide whether to run integration tests
        id: should_run_integration
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.ref }}" == "refs/heads/main" || "${{ env.ENABLE_INTEGRATION }}" == "true" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi
      - name: Run integration tests stack
        if: ${{ steps.should_run_integration.outputs.run == 'true' }}
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          chmod +x ./scripts/run-integration-tests.sh
          ./scripts/run-integration-tests.sh
      - name: Publish integration test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: backend/test-results
      - name: Publish integration compose logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-compose-logs
          path: |
            docker-compose.integration.log
      - name: Upload integration test junit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            backend/test-results/junit.xml

  e2e-tests:
    name: E2E (Playwright) tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Playwright dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps
      - name: Start integration compose stack (frontend + backend)
        run: |
          docker compose --profile dev --profile test up -d backend-uat frontend-uat
      - name: Run Playwright tests
        env:
          API_URL: http://localhost:8080
        run: |
          mkdir -p frontend/playwright-report
          cd frontend
          CI=true npm run test:e2e -- --reporter=list
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            frontend/playwright-report
            frontend/playwright-report/junit.xml
